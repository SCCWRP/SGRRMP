---
title: 'Constraints on biological condition in the San Gabriel River'
author: 'Raphael D. Mazor and Marcus Beck'
date: 'November 15, 2017'
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
self_contained: yes
---

```{r setup, include = FALSE}
library(ggmap)
library(rgdal)
library(plyr)
knitr::opts_chunk$set(echo  =  TRUE, warning  =  F, message  =  F)
```

## Basemap

This is a basemap of the San Gabriel River watershed, from google maps.
It's a black-and-white satellite view, with a transparent gray rectangle on top, which should make overplotting easier to see.
```{r basemap, echo  =  TRUE}

load('data/spatial_data/nhd.sgr.fort.Rdata')
sg.box <- make_bbox(lon = nhd.sgr.fort$long, lat = nhd.sgr.fort$lat, f = 0.25)
sg.map <- get_map(location = sg.box, zoom = 10, source = 'google', maptype = 'satellite', color = 'bw')
base <- ggmap(sg.map) +
  geom_rect(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, fill = 'white', alpha  =  0.2)+
  coord_map(xlim = c(min(nhd.sgr.fort$long, na.rm = T)-.025,max(nhd.sgr.fort$long, na.rm = T)+.025),
            ylim = c(min(nhd.sgr.fort$lat, na.rm = T)-.025,max(nhd.sgr.fort$lat, na.rm = T)+.025)) +
  theme(
    axis.title.x = element_blank(), 
    axis.title.y = element_blank()
  )
base

```

## Add flowlines

I have the fortified flowlines for the San Gabriel River from NHD+.
```{r add flowlines, echo  =  TRUE}
base+
  geom_path(data = nhd.sgr.fort, aes(x = long, y = lat, group = COMID), color = '#1f78b4')
```

## Overlay observed scores

I have several sites, with replicates. We will plot the mean CSCI score at each location.

```{r add scores, echo  =  TRUE}
load('data/csci.Rdata')
load('data/sites.Rdata')
load('data/comid_statewide.Rdata')
csci.d <- ddply(csci, .(StationCode), summarize, csci = max(Result, na.rm = T))
sites.comid <- join(sites, comid)
sites.c <- join(sites.comid, csci.d)
sites.reps <- join(sites.comid,csci[,c('StationCode','SampleDate', 'Result')])

n.sites <- length(unique(sites.c$StationCode))
n.samps <- nrow(unique(csci[which(csci$StationCode %in% sites$StationCode), c('StationCode','SampleDate', 'FieldSampleID')]))
n.segs <- length(unique(sites.c$COMID))
base+
 geom_path(data = nhd.sgr.fort, aes(x = long, y = lat, group = COMID), color = '#1f78b4')+
  geom_point(data = sites.c[!is.na(sites.c$csci),], aes(x = ActualLongitude, y = ActualLatitude,
                              fill = csci), size = 3, shape = 21)+
 scale_fill_gradient2(name = 'Observed score', high = '#2c7bb6', mid = '#abd9e9', low = '#d7191c', midpoint  =  0.79)
```

There are `r n.samps` sampling events from `r n.sites` unique locations on `r n.segs` unique stream-segments.
